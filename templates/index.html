<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Price Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e17;
            color: #e1e4e8;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #0d1321 0%, #1a1f36 100%);
            border-bottom: 1px solid #2a2f45;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 600;
            color: #fff;
        }

        .header h1 span {
            color: #f0b90b;
            font-weight: 700;
        }

        .pair-selector {
            display: flex;
            gap: 4px;
            background: #141929;
            border-radius: 8px;
            padding: 4px;
            border: 1px solid #2a2f45;
        }

        .pair-btn {
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #8b8fa3;
            transition: all 0.2s;
            border: none;
            background: none;
        }

        .pair-btn:hover { color: #e1e4e8; }
        .pair-btn.active { background: #f0b90b; color: #0a0e17; }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 13px;
            color: #8b8fa3;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00c853;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-dot.error { background: #ff5252; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
        }

        /* Summary Cards Row */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: linear-gradient(135deg, #141929 0%, #1a1f36 100%);
            border: 1px solid #2a2f45;
            border-radius: 12px;
            padding: 20px 24px;
            position: relative;
            overflow: hidden;
        }

        .summary-card.mexc {
            border-color: #1ce0c8;
            box-shadow: 0 0 20px rgba(28, 224, 200, 0.08);
        }

        .summary-card.binance { border-color: #f0b90b33; }
        .summary-card.bybit { border-color: #f7a60033; }
        .summary-card.okx { border-color: #ffffff22; }

        .summary-card .badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #1ce0c8;
            color: #0a0e17;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            display: none;
        }

        .summary-card.mexc .badge { display: inline-block; }

        .exchange-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .exchange-name .logo {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 11px;
        }

        .mexc .logo { background: #1ce0c8; color: #0a0e17; }
        .binance .logo { background: #f0b90b; color: #0a0e17; }
        .bybit .logo { background: #f7a600; color: #0a0e17; }
        .okx .logo { background: #fff; color: #0a0e17; }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .price-label {
            font-size: 12px;
            color: #8b8fa3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .price-value {
            font-size: 22px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .price-value.buy { color: #00c853; }
        .price-value.sell { color: #ff5252; }

        .spread-bar {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #2a2f45;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .spread-bar .label { color: #8b8fa3; }
        .spread-bar .value { color: #f0b90b; font-weight: 600; }

        .ad-count {
            font-size: 11px;
            color: #5a5f73;
        }

        .error-msg {
            color: #ff5252;
            font-size: 12px;
            margin-top: 8px;
            padding: 8px;
            background: #ff525210;
            border-radius: 6px;
        }

        /* Ads Detail Table */
        .detail-section {
            margin-top: 30px;
        }

        .detail-section h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #8b8fa3;
        }

        .tabs {
            display: flex;
            gap: 4px;
            background: #141929;
            border-radius: 8px;
            padding: 4px;
            border: 1px solid #2a2f45;
            width: fit-content;
        }

        .tab {
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #8b8fa3;
            transition: all 0.2s;
            border: none;
            background: none;
        }

        .tab:hover { color: #e1e4e8; }
        .tab.active { background: #2a2f45; color: #fff; }

        .ads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 12px;
        }

        .ad-card {
            background: #141929;
            border: 1px solid #2a2f45;
            border-radius: 10px;
            padding: 16px;
            transition: border-color 0.2s;
        }

        .ad-card:hover { border-color: #3a3f55; }

        .ad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ad-merchant {
            font-weight: 600;
            font-size: 14px;
        }

        .ad-exchange-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tag-mexc { background: #1ce0c820; color: #1ce0c8; }
        .tag-binance { background: #f0b90b20; color: #f0b90b; }
        .tag-bybit { background: #f7a60020; color: #f7a600; }
        .tag-okx { background: #ffffff20; color: #fff; }

        .ad-price {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .ad-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            font-size: 12px;
            color: #8b8fa3;
        }

        .ad-details span { display: block; }
        .ad-details .val { color: #c9ccd5; font-weight: 500; }

        .payment-tags {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .payment-tag {
            background: #2a2f45;
            color: #8b8fa3;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .exchange-filters {
            display: flex;
            gap: 4px;
            background: #141929;
            border-radius: 8px;
            padding: 4px;
            border: 1px solid #2a2f45;
        }

        .exchange-filter {
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #5a5f73;
            transition: all 0.2s;
            border: none;
            background: none;
            text-transform: uppercase;
        }

        .exchange-filter:hover { color: #8b8fa3; }
        .exchange-filter.active { color: #fff; }
        .exchange-filter.active.f-mexc { background: #1ce0c830; color: #1ce0c8; }
        .exchange-filter.active.f-binance { background: #f0b90b30; color: #f0b90b; }
        .exchange-filter.active.f-bybit { background: #f7a60030; color: #f7a600; }
        .exchange-filter.active.f-okx { background: #ffffff20; color: #fff; }

        /* Payment method dropdown */
        .pay-dropdown {
            position: relative;
        }

        .pay-dropdown-btn {
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #8b8fa3;
            background: #141929;
            border: 1px solid #2a2f45;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pay-dropdown-btn:hover { color: #e1e4e8; border-color: #3a3f55; }
        .pay-dropdown-btn.has-selection { color: #1ce0c8; border-color: #1ce0c850; }

        .pay-dropdown-btn .count-badge {
            background: #1ce0c8;
            color: #0a0e17;
            font-size: 10px;
            font-weight: 700;
            padding: 1px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .pay-dropdown-panel {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            background: #141929;
            border: 1px solid #2a2f45;
            border-radius: 10px;
            padding: 8px 0;
            min-width: 220px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .pay-dropdown-panel.open { display: block; }

        .pay-dropdown-panel .pay-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 14px;
            cursor: pointer;
            font-size: 12px;
            color: #8b8fa3;
            transition: background 0.15s;
        }

        .pay-dropdown-panel .pay-option:hover { background: #1a1f36; }

        .pay-dropdown-panel .pay-option input[type="checkbox"] {
            accent-color: #1ce0c8;
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .pay-dropdown-panel .pay-clear {
            display: block;
            width: calc(100% - 16px);
            margin: 4px 8px 4px;
            padding: 6px;
            border: none;
            border-radius: 6px;
            background: #2a2f45;
            color: #8b8fa3;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .pay-dropdown-panel .pay-clear:hover { background: #3a3f55; color: #e1e4e8; }

        .pay-dropdown-panel .pay-divider {
            height: 1px;
            background: #2a2f45;
            margin: 4px 0;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #5a5f73;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 20px;
            padding: 12px 0;
        }

        .page-btn {
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #8b8fa3;
            background: #141929;
            border: 1px solid #2a2f45;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) { color: #e1e4e8; border-color: #3a3f55; }
        .page-btn:disabled { opacity: 0.3; cursor: default; }
        .page-btn.active { background: #2a2f45; color: #fff; }

        .page-info {
            font-size: 13px;
            color: #5a5f73;
            padding: 0 8px;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #2a2f45;
            border-top-color: #1ce0c8;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }

        .comparison-table th {
            background: #141929;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #8b8fa3;
            border-bottom: 1px solid #2a2f45;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .comparison-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #1a1f36;
        }

        .comparison-table tr:hover td {
            background: #141929;
        }

        .best-price { color: #1ce0c8; font-weight: 700; }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .summary-row { grid-template-columns: 1fr; }
            .ads-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>P2P Price Tracker — <span id="pairLabel">USDT/ETB</span></h1>
            <div class="pair-selector" id="pairSelector">
                {% for p in pairs %}
                <button class="pair-btn{% if loop.first %} active{% endif %}"
                        onclick="switchPair('{{ p.fiat }}', this)">{{ p.fiat }}</button>
                {% endfor %}
            </div>
        </div>
        <div class="status-bar">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Connecting...</span>
            <span>|</span>
            <span id="lastUpdated">—</span>
        </div>
    </div>

    <div class="container">
        <!-- Summary Cards -->
        <div class="summary-row" id="summaryCards">
            <div class="no-data">
                <div class="loading-spinner"></div>
                <p style="margin-top: 12px;">Fetching prices from exchanges...</p>
            </div>
        </div>

        <!-- Comparison Table -->
        <div class="detail-section">
            <h2>Exchange Comparison</h2>
            <table class="comparison-table" id="comparisonTable">
                <thead>
                    <tr>
                        <th>Exchange</th>
                        <th>Best Buy</th>
                        <th>Best Sell</th>
                        <th>Avg Buy</th>
                        <th>Avg Sell</th>
                        <th>Spread</th>
                        <th>Ads</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody">
                    <tr><td colspan="8" class="no-data">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Detailed Ads -->
        <div class="detail-section">
            <h2>Individual Ads</h2>
            <div class="filter-row">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('buy')">Buy Ads</button>
                    <button class="tab" onclick="switchTab('sell')">Sell Ads</button>
                </div>
                <div class="exchange-filters">
                    <button class="exchange-filter f-mexc active" onclick="toggleExchange('MEXC', this)">MEXC</button>
                    <button class="exchange-filter f-binance active" onclick="toggleExchange('Binance', this)">Binance</button>
                    <button class="exchange-filter f-bybit active" onclick="toggleExchange('Bybit', this)">Bybit</button>
                    <button class="exchange-filter f-okx active" onclick="toggleExchange('OKX', this)">OKX</button>
                </div>
                <div class="pay-dropdown" id="payDropdown">
                    <button class="pay-dropdown-btn" id="payDropdownBtn" onclick="togglePayDropdown()">
                        Payment Method
                    </button>
                    <div class="pay-dropdown-panel" id="payDropdownPanel">
                        <button class="pay-clear" onclick="clearPaymentFilter()">Clear All</button>
                        <div class="pay-divider"></div>
                        <div id="payOptionsList"></div>
                    </div>
                </div>
            </div>
            <div class="ads-grid" id="adsGrid">
                <div class="no-data">Waiting for data...</div>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        let currentTab = 'buy';
        let currentFiat = '{{ pairs[0].fiat }}';
        let activeExchanges = new Set(['MEXC', 'Binance', 'Bybit', 'OKX']);
        let currentPage = 1;
        let selectedPayments = new Set();
        const ADS_PER_PAGE = 12;
        const REFRESH_MS = {{ refresh_interval }} * 1000;

        const exchangeOrder = ['MEXC', 'Binance', 'Bybit', 'OKX'];
        const exchangeClasses = {
            'MEXC': 'mexc', 'Binance': 'binance',
            'Bybit': 'bybit', 'OKX': 'okx'
        };

        function formatPrice(price) {
            if (price === null || price === undefined) return '—';
            return Number(price).toLocaleString('en-US', {
                minimumFractionDigits: 2, maximumFractionDigits: 2
            });
        }

        function switchPair(fiat, btn) {
            currentFiat = fiat;
            currentPage = 1;
            selectedPayments.clear();
            updatePayBtnLabel();
            document.querySelectorAll('.pair-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('pairLabel').textContent = 'USDT/' + fiat;
            document.title = 'P2P Price Tracker — USDT/' + fiat;
            fetchPrices();
        }

        function switchTab(tab) {
            currentTab = tab;
            currentPage = 1;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderAds();
        }

        function toggleExchange(exchange, btn) {
            if (activeExchanges.has(exchange)) {
                if (activeExchanges.size === 1) return;
                activeExchanges.delete(exchange);
                btn.classList.remove('active');
            } else {
                activeExchanges.add(exchange);
                btn.classList.add('active');
            }
            currentPage = 1;
            renderAds();
        }

        function togglePayDropdown() {
            document.getElementById('payDropdownPanel').classList.toggle('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('payDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                document.getElementById('payDropdownPanel').classList.remove('open');
            }
        });

        function updatePaymentOptions() {
            if (!currentData) return;
            const methods = new Set();
            currentData.results.forEach(ex => {
                [...ex.buy_ads, ...ex.sell_ads].forEach(ad => {
                    (ad.payment_methods || []).forEach(p => {
                        if (p) methods.add(p);
                    });
                });
            });

            const sorted = [...methods].sort();
            const list = document.getElementById('payOptionsList');
            list.innerHTML = '';

            sorted.forEach(method => {
                const label = document.createElement('label');
                label.className = 'pay-option';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = selectedPayments.has(method);
                cb.onchange = () => togglePayment(method);
                label.appendChild(cb);
                label.appendChild(document.createTextNode(method));
                list.appendChild(label);
            });

            updatePayBtnLabel();
        }

        function togglePayment(method) {
            if (selectedPayments.has(method)) {
                selectedPayments.delete(method);
            } else {
                selectedPayments.add(method);
            }
            currentPage = 1;
            updatePayBtnLabel();
            renderAds();
        }

        function clearPaymentFilter() {
            selectedPayments.clear();
            currentPage = 1;
            updatePaymentOptions();
            renderAds();
        }

        function updatePayBtnLabel() {
            const btn = document.getElementById('payDropdownBtn');
            if (selectedPayments.size === 0) {
                btn.innerHTML = 'Payment Method';
                btn.classList.remove('has-selection');
            } else {
                btn.innerHTML = `Payment Method <span class="count-badge">${selectedPayments.size}</span>`;
                btn.classList.add('has-selection');
            }
        }

        function renderSummary(results) {
            const container = document.getElementById('summaryCards');
            container.innerHTML = '';

            const sorted = [...results].sort((a, b) =>
                exchangeOrder.indexOf(a.exchange) - exchangeOrder.indexOf(b.exchange)
            );

            sorted.forEach(ex => {
                const cls = exchangeClasses[ex.exchange] || '';
                const spread = (ex.best_sell_price && ex.best_buy_price)
                    ? (ex.best_sell_price - ex.best_buy_price).toFixed(2)
                    : '—';
                const spreadPct = (ex.best_sell_price && ex.best_buy_price)
                    ? ((ex.best_sell_price - ex.best_buy_price) / ex.best_buy_price * 100).toFixed(2) + '%'
                    : '—';

                const card = document.createElement('div');
                card.className = `summary-card ${cls}`;
                card.innerHTML = `
                    <span class="badge">Priority</span>
                    <div class="exchange-name">
                        <span class="logo">${ex.exchange.charAt(0)}</span>
                        ${ex.exchange}
                    </div>
                    ${ex.error ? `<div class="error-msg">${ex.error}</div>` : `
                    <div class="price-row">
                        <div>
                            <div class="price-label">Best Buy Price</div>
                            <div class="price-value buy">${formatPrice(ex.best_buy_price)} ${currentFiat}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="price-label">Best Sell Price</div>
                            <div class="price-value sell">${formatPrice(ex.best_sell_price)} ${currentFiat}</div>
                        </div>
                    </div>
                    <div class="spread-bar">
                        <span class="label">Spread</span>
                        <span class="value">${spread} ${currentFiat} (${spreadPct})</span>
                    </div>
                    <div class="ad-count" style="margin-top:6px">
                        ${ex.buy_count} buy ads &middot; ${ex.sell_count} sell ads
                    </div>`}
                `;
                container.appendChild(card);
            });
        }

        function renderComparison(results) {
            const tbody = document.getElementById('comparisonBody');
            tbody.innerHTML = '';

            const sorted = [...results].sort((a, b) =>
                exchangeOrder.indexOf(a.exchange) - exchangeOrder.indexOf(b.exchange)
            );

            const allBuys = sorted.filter(e => e.best_buy_price).map(e => e.best_buy_price);
            const allSells = sorted.filter(e => e.best_sell_price).map(e => e.best_sell_price);
            const bestBuy = allBuys.length ? Math.min(...allBuys) : null;
            const bestSell = allSells.length ? Math.max(...allSells) : null;

            sorted.forEach(ex => {
                const spread = (ex.best_sell_price && ex.best_buy_price)
                    ? (ex.best_sell_price - ex.best_buy_price).toFixed(2)
                    : '—';
                const isBestBuy = ex.best_buy_price === bestBuy;
                const isBestSell = ex.best_sell_price === bestSell;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${ex.exchange}</strong></td>
                    <td class="${isBestBuy ? 'best-price' : ''}">${formatPrice(ex.best_buy_price)}</td>
                    <td class="${isBestSell ? 'best-price' : ''}">${formatPrice(ex.best_sell_price)}</td>
                    <td>${formatPrice(ex.avg_buy_price)}</td>
                    <td>${formatPrice(ex.avg_sell_price)}</td>
                    <td>${spread}</td>
                    <td>${ex.buy_count + ex.sell_count}</td>
                    <td>${ex.error
                        ? '<span style="color:#ff5252">Error</span>'
                        : '<span style="color:#00c853">OK</span>'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function goToPage(page) {
            currentPage = page;
            renderAds();
            document.getElementById('adsGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function renderPagination(totalItems) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            const totalPages = Math.ceil(totalItems / ADS_PER_PAGE);
            if (totalPages <= 1) return;

            // Prev button
            const prev = document.createElement('button');
            prev.className = 'page-btn';
            prev.textContent = 'Prev';
            prev.disabled = currentPage === 1;
            prev.onclick = () => goToPage(currentPage - 1);
            container.appendChild(prev);

            // Page number buttons (show max 7 with ellipsis)
            const maxButtons = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            if (startPage > 1) {
                const btn = document.createElement('button');
                btn.className = 'page-btn';
                btn.textContent = '1';
                btn.onclick = () => goToPage(1);
                container.appendChild(btn);
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.className = 'page-info';
                    dots.textContent = '...';
                    container.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
                btn.textContent = i;
                btn.onclick = () => goToPage(i);
                container.appendChild(btn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.className = 'page-info';
                    dots.textContent = '...';
                    container.appendChild(dots);
                }
                const btn = document.createElement('button');
                btn.className = 'page-btn';
                btn.textContent = totalPages;
                btn.onclick = () => goToPage(totalPages);
                container.appendChild(btn);
            }

            // Next button
            const next = document.createElement('button');
            next.className = 'page-btn';
            next.textContent = 'Next';
            next.disabled = currentPage === totalPages;
            next.onclick = () => goToPage(currentPage + 1);
            container.appendChild(next);

            // Total count
            const info = document.createElement('span');
            info.className = 'page-info';
            info.textContent = `${totalItems} ads`;
            container.appendChild(info);
        }

        function renderAds() {
            if (!currentData) return;
            const grid = document.getElementById('adsGrid');
            grid.innerHTML = '';

            const allAds = [];
            const sorted = [...currentData.results].sort((a, b) =>
                exchangeOrder.indexOf(a.exchange) - exchangeOrder.indexOf(b.exchange)
            );

            sorted.forEach(ex => {
                if (!activeExchanges.has(ex.exchange)) return;
                const ads = currentTab === 'buy' ? ex.buy_ads : ex.sell_ads;
                ads.forEach(ad => {
                    // Payment method filter
                    if (selectedPayments.size > 0) {
                        const hasMatch = (ad.payment_methods || []).some(p => selectedPayments.has(p));
                        if (!hasMatch) return;
                    }
                    allAds.push({ ...ad, exchange: ex.exchange });
                });
            });

            if (currentTab === 'buy') {
                allAds.sort((a, b) => a.price - b.price);
            } else {
                allAds.sort((a, b) => b.price - a.price);
            }

            if (allAds.length === 0) {
                grid.innerHTML = '<div class="no-data">No ads available</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            // Paginate
            const totalPages = Math.ceil(allAds.length / ADS_PER_PAGE);
            if (currentPage > totalPages) currentPage = totalPages;
            const start = (currentPage - 1) * ADS_PER_PAGE;
            const pageAds = allAds.slice(start, start + ADS_PER_PAGE);

            pageAds.forEach((ad, i) => {
                const cls = exchangeClasses[ad.exchange] || '';
                const tagCls = `tag-${cls}`;
                const priceColor = currentTab === 'buy' ? 'color:#00c853' : 'color:#ff5252';

                const card = document.createElement('div');
                card.className = 'ad-card';
                card.innerHTML = `
                    <div class="ad-header">
                        <span class="ad-merchant">${ad.merchant}</span>
                        <span class="ad-exchange-tag ${tagCls}">${ad.exchange}</span>
                    </div>
                    <div class="ad-price" style="${priceColor}">${formatPrice(ad.price)} ${currentFiat}</div>
                    <div class="ad-details">
                        <span>Available: <span class="val">${formatPrice(ad.available_amount)} USDT</span></span>
                        <span>Limit: <span class="val">${formatPrice(ad.min_amount)} - ${formatPrice(ad.max_amount)}</span></span>
                    </div>
                    <div class="payment-tags">
                        ${(ad.payment_methods || []).map(p =>
                            `<span class="payment-tag">${p || 'Unknown'}</span>`
                        ).join('')}
                    </div>
                `;
                grid.appendChild(card);
            });

            renderPagination(allAds.length);
        }

        async function fetchPrices() {
            try {
                const resp = await fetch('/api/prices?fiat=' + currentFiat);
                const data = await resp.json();

                if (data.results && data.results.length > 0) {
                    currentData = data;
                    updatePaymentOptions();
                    renderSummary(data.results);
                    renderComparison(data.results);
                    renderAds();

                    document.getElementById('statusDot').className = 'status-dot';
                    document.getElementById('statusText').textContent = 'Live';
                    document.getElementById('lastUpdated').textContent =
                        'Updated: ' + (data.last_refresh || '—');
                }
            } catch (err) {
                document.getElementById('statusDot').className = 'status-dot error';
                document.getElementById('statusText').textContent = 'Connection error';
                console.error('Fetch error:', err);
            }
        }

        // Initial fetch + interval
        fetchPrices();
        setInterval(fetchPrices, REFRESH_MS);
    </script>
</body>
</html>
